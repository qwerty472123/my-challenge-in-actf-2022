## CryptoNote

`blockchain_service.py` is a "blockchain" transaction system that mimics the architecture of HyperLedger Fabric [1] (not the key point for capture the flag) and Monero's CryptoNote transactions[2].

Monero uses ed25519. Since our elliptic curve is implemented by SageMath which does not support twisted edwards curve, the corresponding curve25519 on montgomery curve is used here.

### Restore Bob's public key

The gmssl library is used for SM2 signature. Since the gmssl library only supports short weierstrass curve, the public key and curve are transformed accordingly[3].

We know that transactions on Ethereum does not need to be attached with the public key, but only need to have a signature and rec_id (i.e. v). During verification, the full node only need to use the ecrecover algorithm [4] to restore the public key from the message and signature.

The naked SM2 signature also has such properties (as long as the digest of the message, i.e. $e$, is independent of the public key).

The SM2 signature process [5] is as follows (note the base point of the curve, the order of the curve, the order of the base field of the curve, the public key, the private key, and the digest of the message are $G,n,q,K,k,e$):

1.  Randomly select $d$ from $[1,n)$;
2.  $R=[d]G$；
3.  $r\equiv e+R.x \pmod n$；
4.  $s\equiv (1+k)^{-1}(d-rk)\pmod n$；
5.  Return $(r,s)$.

Rewrite the formula in 4, we can obtain $k\equiv (r+s)^{-1}d-(r+s)^{-1}s\pmod n$；Multiply by $G$ to get $[k]G=[(r+s)^{-1}d]G-[(r+s)^{-1}s]G$；that is to say $K=[(r+s)^{-1}]R-[(r+s)^{-1}s]G$.

So as long as $R$ is determined, $K$ can be calculated.

Considering the formula in 3, note that $R.x\leq q$, so $0\leq R.x+e\leq q+e$, deform the formula in 3 into $r=e+R.x-un$, where $u$ is an integer satisfying $0\leq un\leq q+e$.

Enumerate all possible $u$ and parity cases of $R.y$ to  obtain $R$. There are $2\lceil\frac{q+e}{n}\rceil$ possibilities in total. Just try all of them.

###  Restore Carol's public key

The proof used here is one kind of zero knowledge range proof for Pederson commitment, which is implemented based on several ring signatures. For details of this kind of range proof, refer to section 5 of [11].

Ring signature is a signature scheme. The verifier can know whether the signature is generated by the private key corresponding to one of public key in a public key "ring" composed of several public keys or not, but cannot know which private key the signer used in the signing process.

The ring signature itself has full anonymity. Even if the ECDLP is solvable, it will not disclose the information of "which private key is used by the signer to sign" (but the signature can be forged). However, here, we use one of the one-time ring signature named back-style LSAG, and its anonymity depends on the difficulty of ECDDHP. For details of one-time ring signature, please refer to [7].

The only detail you need to know for solving this problem is that every one-time ring signature have one part called "key image" $I=k\mathcal{H}_p(K)$, where $\mathcal{H}_p$ is a cryptographic secure hash function that maps parameters to one point on the elliptic curve, $K,k$ are the public key and private key actually used by the signature, respectively, where $K = kG$, $G$ is the base point of the elliptic curve.

A special curve is selected here. It seems that a curve with larger order is used to prove the range of $[0,2^{256}]$, but it is also a type-A pairing friendly curve[10] with embedding degree one[9], so the bilinear mapping $e$ is computable.

The existence of computable bilinear mapping $e$ can destroy the difficulty of ECDDHP. Enumerating each public key on the public key ring, only the public key $K$ actually used to sign is satisfied $e(K,\mathcal{H}_p(K))=e(kG,\mathcal{H}_p(K))=e(G,\mathcal{H}_p(K))^k=e(G,k\mathcal{H}_p(K))=e(G,I)$.

In addition, the subgroup membership test can also be used to solve the problem. Since the given elliptic curve group is not a cyclic group, there's a good probability that only the public key $K$ actually used for signing satisfies $I,\mathcal{H}_p(K)$ is on the same cyclic subgroup (or being linear correlation). If and only if $P,Q$ are two points on the same cyclic subgroup, their Weil pairing satisfied $e(P,Q)=1$.

Thus, we can recover the x-coordinate of Carol's public key from the range proof. In this way, there are only two possibilities for Carol's public key. Just try them.

### Construct double-spend transaction

Since Alice only have one token but she need to give two tokens to other people, you need to construct double-spend transactions.

A transaction system similar to Monero is used here (anonymous address and other contents are deleted here, so a small modification is made to allow key-reuse to the key image that will not affect the analysis). Therefore, The method to know whether double-spend is used is to check whether the signature of transaction has the same key image of one of other transactions.

For the vulnerability of double-spend in Monero, you can find the disclosure[8] with some keywords such as `cryptonote double spend`, or you can see the comments about the corresponding patch in [6]. A brief description of this vulnerability is as follows:

The order of ed25519 curve is $8l$, where $l$ is a large prime number, and the order of the base point recommended by ed25519 is $l$. Because ed25519 curve is a cyclic group, we can find $7$ points with the order in the range $[2,8]$ and note that one of this points is $x$. Notice that $c_iI=c_i(I+X)$ is always hold when $c_i$ is a multiple of $8$. So, when all $c_i$ meet this condition, you can use $I'=I+X$ to impersonate the key image to achieve the purpose of double-spend.

#### Unexpected solution

The verification of ring signature use  `c_next = Hn(self.n, m, Li, Ri)`，but in fact, we should use `c_next = Hn(self.n, Ks, I, m, Li, Ri)`to avoid double-spend problem.

Otherwise, let `Ri = beta * Hp(...)` in the first, and let `I = (b-r)/c * H_p(...)` in the last is OK for create another I. Let `I` into `Hn(...)` require signer know `I` before `c`.

That's a bug in the implementation.

### References

1. HyperLedger Fabric Key Concepts, <https://hyperledger-fabric.readthedocs.io/en/latest/blockchain.html>.
2. Saberhagen, N.V. (2013). CryptoNote v 2.0.
3. Convert between short weierstrass curve and montgomery curve, <https://blog.csdn.net/mutourend/article/details/96293640>.
4. ECRecover and Signature Verification in Ethereum, <https://coders-errand.com/ecrecover-signature-verification-ethereum/>.
5. SM2 Digital Signature Algorithm, <https://datatracker.ietf.org/doc/html/draft-shen-sm2-ecdsa-02>
6. Alonso, K.M. (2018). Zero to Monero : First Edition.
7. koe, K.M. (2020). Zero to Monero: Second Edition.
8. Disclosure of a Major Bug in CryptoNote Based Currencies, <https://www.getmonero.org/2017/05/17/disclosure-of-a-major-bug-in-cryptonote-based-currencies.html>.
9. Koblitz, N., & Menezes, A. (2005). Pairing-based cryptography at high security levels. In IMA International Conference on Cryptography and Coding (pp. 13-36). Springer, Berlin, Heidelberg.
10. Chatterjee, S., Menezes, A., & Rodrıguez-Henrıquez, F. (2016). On instantiating pairing-based protocols with elliptic curves of embedding degree one. IEEE Transactions on Computers, 66(6), 1061-1070.
11. Noether, S., & Mackenzie, A. (2016). Ring confidential transactions. Ledger, 1, 1-18.